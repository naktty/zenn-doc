---
title: ""
emoji: "💬"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

# GraphQL::Batchとは
[公式のREADME](https://github.com/Shopify/graphql-batch?tab=readme-ov-file#graphqlbatch)によると...
> Provides an executor for the graphql gem which allows queries to be batched.

直訳：クエリをバッチ処理できる graphql gem 用のエクゼキュータを提供します

直訳だとよくわからなかったのですが、主にGraphQLで発生するN+1問題を解決するためのライブラリだと理解してます。


# N+1問題の例とGraphQL::Batchによる解決策
## version
下記を前提とします。

- Ruby 3.3.1
- Rails 7.0.8
- graphql 2.4.9
- graphql-batch 0.6.0

## N+1問題の具体例
前準備として下記のようなModel、Type、Query、Resolverを用意しました。

### Model
UserモデルとPhotoモデルを作成し、1対多の関連を設定します。

```ruby
# app/models/user.rb
class User < ApplicationRecord
  has_many :photos, dependent: :destroy
end

# app/models/photo.rb
class Photo < ApplicationRecord
  belongs_to :user
end
```

### Type
UserTypeとPhotoTypeを作成し、UserTypeにはposted_photosフィールドを設定して、Userが投稿したPhotoを取得できるようにします。
```ruby
# app/graphql/types/user_type.rb
module Types
  class UserType < Types::BaseObject
    field :id, ID, null: false
    field :name, String
    field :posted_photos, [Types::PhotoType], null: false

    def posted_photos
      object.photos
    end
  end
end

# app/graphql/types/photo_type.rb
module Types
  class PhotoType < Types::BaseObject
    field :id, ID, null: false
    field :name, String, null: false
    field :posted_by, Types::UserType, null: false

    def posted_by
      object.user
    end
  end
end

```

### Resolvers
すべてのユーザーを取得するQueryを作成します。
```ruby
# app/graphql/resolvers/all_users.rb
module Resolvers
  class AllUsers < BaseResolver
    type [Types::UserType], null: false

    def resolve
      ::User.all
    end
  end
end
```

### Query
用意したModel、Type、Resolverを利用して、GraphiQLで下記のクエリを実行すると...
```graphql
query {
  allUsers {
    id
    name
    postedPhotos {
      name
    }
  }
}
```

### Response
クエリの結果はこのようになります。
```json
{
  "data": {
    "allUsers": [
      {
        "id": "1",
        "name": "テストユーザー1",
        "postedPhotos": [
          {
            "name": "カフェでの一枚"
          },
          {
            "name": "美味しい料理"
          },
          {
            "name": "チームミーティング"
          }
        ]
      },
      {
        "id": "2",
        "name": "テストユーザー2",
        "postedPhotos": [
          {
            "name": "山の頂上"
          },
          {
            "name": "お気に入りの場所"
          },
          // 以下略
    ]
  }
}
```

### 発行されるSQL
Railsのログを確認すると、下記のようなSQLが発行されており、N+1問題が発生していることがわかります。

```sql
User Load (0.9ms)  SELECT `users`.* FROM `users`
Photo Load (0.3ms)  SELECT `photos`.* FROM `photos` WHERE `photos`.`user_id` = 1
Photo Load (0.2ms)  SELECT `photos`.* FROM `photos` WHERE `photos`.`user_id` = 2
Photo Load (0.1ms)  SELECT `photos`.* FROM `photos` WHERE `photos`.`user_id` = 3
Photo Load (0.1ms)  SELECT `photos`.* FROM `photos` WHERE `photos`.`user_id` = 4
Photo Load (0.1ms)  SELECT `photos`.* FROM `photos` WHERE `photos`.`user_id` = 5
```

## GraphQL::Batchによる解決策
